# =============================================================================
# Appname Full Stack Docker (Weryfikacja)
# =============================================================================
#
# Pełny stack w kontenerach - do weryfikacji czy wszystko działa.
# NIE do aktywnego developmentu (brak HMR).
#
# Usage:
#   pnpm docker:build       # Zbuduj obrazy
#   pnpm docker:up          # Start core (postgres, redis, api, web)
#   pnpm docker:up:workers  # + Workers
#   pnpm docker:up:all      # Wszystko
#   pnpm docker:down        # Stop
#   pnpm docker:logs        # Logi
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 + PostGIS 3.4
  # ===========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
      TZ: Europe/Warsaw
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d app']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - appname-network

  # ===========================================================================
  # Redis 7
  # ===========================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - '6379:6379'
    command:
      [
        'redis-server',
        '--appendonly',
        'yes',
        '--maxmemory',
        '256mb',
        '--maxmemory-policy',
        'allkeys-lru',
      ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - appname-network

  # ===========================================================================
  # API - Fastify + GraphQL + Prisma
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: development
      HOST: '0.0.0.0'
      PORT: '4000'
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MEDIA_STORAGE_PROVIDER: LOCAL
      UPLOADS_PATH: /app/uploads
      UPLOADS_TMP_PATH: /app/tmp/uploads
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      APP_URL: http://localhost:3000
      API_URL: http://localhost:4000
      ASSETS_BASE_URL: http://localhost:4000
      ENABLE_BULL_BOARD: 'true'
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    volumes:
      - api_uploads:/app/uploads
      - api_tmp:/app/tmp/uploads
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:4000/health/live']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - appname-network

  # ===========================================================================
  # Web - Next.js 15
  # ===========================================================================
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
      PORT: '3000'
      NEXT_PUBLIC_API_URL: http://localhost:4000/graphql
      NEXT_PUBLIC_WS_URL: ws://localhost:4000/graphql
      INTERNAL_API_URL: http://api:4000/graphql
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - appname-network

  # ===========================================================================
  # Workers (Profile: workers)
  # ===========================================================================
  worker_reminders:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:reminders']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_feedback:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:feedback']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_audit:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:audit-archive']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
    volumes:
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # Adminer (Profile: tools)
  # ===========================================================================
  adminer:
    image: adminer:latest
    restart: unless-stopped
    profiles: ['tools', 'all']
    ports:
      - '8080:8080'
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # Stripe CLI (Profile: stripe)
  # ===========================================================================
  stripe:
    image: stripe/stripe-cli:latest
    restart: unless-stopped
    profiles: ['stripe', 'all']
    command:
      [
        'listen',
        '--forward-to',
        'http://api:4000/webhooks/stripe',
        '--log-level',
        'info',
      ]
    environment:
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_DEVICE_NAME: appname-docker
    depends_on:
      api:
        condition: service_healthy
    networks:
      - appname-network

# =============================================================================
# Networks
# =============================================================================
networks:
  appname-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: appname-postgres-data
  redis_data:
    name: appname-redis-data
  api_uploads:
    name: appname-api-uploads
  api_tmp:
    name: appname-api-tmp
  api_audit:
    name: appname-api-audit
