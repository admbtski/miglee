# =============================================================================
# Appname Full Stack Docker (Development)
# =============================================================================
#
# Pełny stack w kontenerach - do weryfikacji czy wszystko działa.
# NIE do aktywnego developmentu (brak HMR).
#
# Usage:
#   pnpm dev:docker:build        # Zbuduj obrazy
#   pnpm dev:docker:up           # Start core (postgres, redis, api, web)
#   pnpm dev:docker:migrate      # Migracje DB
#   pnpm dev:docker:migrate:seed # Migracje + seed dev
#   pnpm dev:docker:up:workers   # + Workers
#   pnpm dev:docker:up:all       # Wszystko
#   pnpm dev:docker:down         # Stop
#   pnpm dev:docker:logs         # Logi
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 + PostGIS 3.4
  # ===========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
      TZ: Europe/Warsaw
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d app']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - appname-network

  # ===========================================================================
  # Redis 7
  # ===========================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - '6379:6379'
    command:
      [
        'redis-server',
        '--appendonly',
        'yes',
        '--maxmemory',
        '256mb',
        '--maxmemory-policy',
        'allkeys-lru',
      ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - appname-network

  # ===========================================================================
  # Migrator (one-off job for DB migrations + optional seed)
  # ===========================================================================
  migrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: migrator
    profiles: ['migrator']
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      # Set RUN_SEED=0 to skip seed, default is 1 for dev
      RUN_SEED: ${RUN_SEED:-1}
      SEED_TYPE: ${SEED_TYPE:-dev}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # API - Fastify + GraphQL + Prisma
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: development
      SERVICE_NAME: ${SERVICE_NAME:-app}
      HOST: '0.0.0.0'
      PORT: '4000'
      # Database
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_TLS: 'false'
      # Security
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      LOG_FILE_PATH: ${LOG_FILE_PATH:-}
      # URLs
      APP_URL: http://localhost:3000
      API_URL: http://localhost:4000
      ASSETS_BASE_URL: http://localhost:4000
      # Storage
      MEDIA_STORAGE_PROVIDER: LOCAL
      UPLOADS_PATH: /app/uploads
      UPLOADS_TMP_PATH: /app/tmp/uploads
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      # Image processing
      IMAGE_MAX_WIDTH: ${IMAGE_MAX_WIDTH:-2560}
      IMAGE_MAX_HEIGHT: ${IMAGE_MAX_HEIGHT:-2560}
      IMAGE_FORMAT: ${IMAGE_FORMAT:-webp}
      IMAGE_QUALITY: ${IMAGE_QUALITY:-85}
      # Media cleanup
      ENABLE_MEDIA_CLEANUP: ${ENABLE_MEDIA_CLEANUP:-false}
      MEDIA_CLEANUP_INTERVAL_HOURS: ${MEDIA_CLEANUP_INTERVAL_HOURS:-24}
      MEDIA_CLEANUP_AGE_DAYS: ${MEDIA_CLEANUP_AGE_DAYS:-7}
      # CDN
      CDN_ENABLED: ${CDN_ENABLED:-false}
      CDN_BASE_URL: ${CDN_BASE_URL:-}
      # Admin
      ENABLE_BULL_BOARD: 'true'
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_SUB: ${STRIPE_PRICE_USER_PLUS_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_SUB: ${STRIPE_PRICE_USER_PRO_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF:-}
      STRIPE_PRICE_ACTION_PACKAGE_SMALL: ${STRIPE_PRICE_ACTION_PACKAGE_SMALL:-}
      STRIPE_PRICE_ACTION_PACKAGE_MEDIUM: ${STRIPE_PRICE_ACTION_PACKAGE_MEDIUM:-}
      STRIPE_PRICE_ACTION_PACKAGE_LARGE: ${STRIPE_PRICE_ACTION_PACKAGE_LARGE:-}
      STRIPE_PRICE_EVENT_PLUS: ${STRIPE_PRICE_EVENT_PLUS:-}
      STRIPE_PRICE_EVENT_PRO: ${STRIPE_PRICE_EVENT_PRO:-}
      # Email
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    volumes:
      - api_uploads:/app/uploads
      - api_tmp:/app/tmp/uploads
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:4000/health/live']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - appname-network

  # ===========================================================================
  # Web - Next.js 15
  # ===========================================================================
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
      PORT: '3000'
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000/graphql}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:4000/graphql}
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY:-}
      INTERNAL_API_URL: http://api:4000/graphql
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - appname-network

  # ===========================================================================
  # Workers (Profile: workers)
  # ===========================================================================
  worker_reminders:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:reminders']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_feedback:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:feedback']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_audit:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:audit-archive']
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
    volumes:
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # Adminer (Profile: tools)
  # ===========================================================================
  adminer:
    image: adminer:latest
    restart: unless-stopped
    profiles: ['tools', 'all']
    ports:
      - '8080:8080'
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # Stripe CLI (Profile: stripe)
  # ===========================================================================
  stripe:
    image: stripe/stripe-cli:latest
    restart: unless-stopped
    profiles: ['stripe', 'all']
    command:
      [
        'listen',
        '--forward-to',
        'http://api:4000/webhooks/stripe',
        '--log-level',
        'info',
      ]
    environment:
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_DEVICE_NAME: appname-docker
    depends_on:
      api:
        condition: service_healthy
    networks:
      - appname-network

# =============================================================================
# Networks
# =============================================================================
networks:
  appname-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: appname-dev-postgres-data
  redis_data:
    name: appname-dev-redis-data
  api_uploads:
    name: appname-dev-api-uploads
  api_tmp:
    name: appname-dev-api-tmp
  api_audit:
    name: appname-dev-api-audit
