# =============================================================================
# Appname Full Stack Docker (Development)
# =============================================================================
#
# Pełny stack w kontenerach - do weryfikacji czy wszystko działa.
# NIE do aktywnego developmentu (brak HMR).
#
# Setup:
#   cp env.docker.dev.example .env
#
# Usage:
#   pnpm dev:docker:build        # Zbuduj obrazy
#   pnpm dev:docker:up:infra     # Start tylko postgres + redis
#   pnpm dev:docker:migrate      # Migracje + seed (default: RUN_SEED=1)
#   pnpm dev:docker:up           # Start core (postgres, redis, api, web)
#   pnpm dev:docker:up:workers   # + Workers
#   pnpm dev:docker:up:all       # Wszystko (workers, tools, stripe)
#   pnpm dev:docker:down         # Stop
#   pnpm dev:docker:logs         # Logi
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 + PostGIS 3.4
  # ===========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    container_name: postgres
    restart: unless-stopped
    # Enable pg_stat_statements for postgres-exporter
    command:
      - postgres
      - -c
      - shared_preload_libraries=pg_stat_statements
      - -c
      - pg_stat_statements.track=all
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
      TZ: Europe/Warsaw
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-pg-stat-statements.sql:/docker-entrypoint-initdb.d/init-pg-stat-statements.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d app']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - appname-network
      - observability
    labels:
      - 'com.appname.service=postgres'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Redis 7
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command:
      [
        'redis-server',
        '--appendonly',
        'yes',
        '--maxmemory',
        '256mb',
        '--maxmemory-policy',
        'noeviction',
      ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - appname-network
      - observability
    labels:
      - 'com.appname.service=redis'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Migrator (one-off job for DB migrations + optional seed)
  # ===========================================================================
  migrator:
    image: appname-migrator:dev
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: migrator
    profiles: ['migrator']
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      # Set RUN_SEED=0 to skip seed, default is 1 for dev
      RUN_SEED: ${RUN_SEED:-1}
      SEED_TYPE: ${SEED_TYPE:-dev}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # API - Fastify + GraphQL + Prisma
  # ===========================================================================
  api:
    image: appname-api:dev
    container_name: api
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    ports:
      - '4000:4000'
    labels:
      - 'com.appname.service=api'
      - 'com.appname.env=dev'
      - 'prometheus.io/scrape=true'
      - 'prometheus.io/port=4000'
      - 'prometheus.io/path=/metrics'
    environment:
      NODE_ENV: development
      SERVICE_NAME: ${SERVICE_NAME:-app}
      HOST: '0.0.0.0'
      PORT: '4000'
      # Database
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_TLS: 'false'
      # Security
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      LOG_FILE_PATH: ${LOG_FILE_PATH:-}
      # URLs
      APP_URL: http://localhost:3000
      API_URL: http://localhost:4000
      ASSETS_BASE_URL: http://localhost:4000
      # Storage
      MEDIA_STORAGE_PROVIDER: LOCAL
      UPLOADS_PATH: /app/uploads
      UPLOADS_TMP_PATH: /app/tmp/uploads
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      # Image processing
      IMAGE_MAX_WIDTH: ${IMAGE_MAX_WIDTH:-2560}
      IMAGE_MAX_HEIGHT: ${IMAGE_MAX_HEIGHT:-2560}
      IMAGE_FORMAT: ${IMAGE_FORMAT:-webp}
      IMAGE_QUALITY: ${IMAGE_QUALITY:-85}
      # CDN
      CDN_ENABLED: ${CDN_ENABLED:-false}
      CDN_BASE_URL: ${CDN_BASE_URL:-}
      # Admin
      ENABLE_BULL_BOARD: 'true'
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_SUB: ${STRIPE_PRICE_USER_PLUS_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_SUB: ${STRIPE_PRICE_USER_PRO_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF:-}
      STRIPE_PRICE_ACTION_PACKAGE_SMALL: ${STRIPE_PRICE_ACTION_PACKAGE_SMALL:-}
      STRIPE_PRICE_ACTION_PACKAGE_MEDIUM: ${STRIPE_PRICE_ACTION_PACKAGE_MEDIUM:-}
      STRIPE_PRICE_ACTION_PACKAGE_LARGE: ${STRIPE_PRICE_ACTION_PACKAGE_LARGE:-}
      STRIPE_PRICE_EVENT_PLUS: ${STRIPE_PRICE_EVENT_PLUS:-}
      STRIPE_PRICE_EVENT_PRO: ${STRIPE_PRICE_EVENT_PRO:-}
      # Email
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
      # OpenTelemetry (connect to observability stack if running)
      OTEL_SERVICE_NAME: appname-api
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_TRACE_SAMPLE_RATE: ${OTEL_TRACE_SAMPLE_RATE:-1.0}
      OTEL_ENABLE_TRACING: ${OTEL_ENABLE_TRACING:-true}
      OTEL_ENABLE_METRICS: ${OTEL_ENABLE_METRICS:-true}
      OTEL_ENABLE_LOGGING: ${OTEL_ENABLE_LOGGING:-true}
      OTEL_DEBUG: ${OTEL_DEBUG:-true}
    volumes:
      - api_uploads:/app/uploads
      - api_tmp:/app/tmp/uploads
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:4000/health/live']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - appname-network
      - observability

  # ===========================================================================
  # Web - Next.js 15
  # ===========================================================================
  web:
    image: appname-web:dev
    container_name: web
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    restart: unless-stopped
    ports:
      - '3000:3000'
    labels:
      - 'com.appname.service=web'
      - 'com.appname.env=dev'
      - 'prometheus.io/scrape=true'
      - 'prometheus.io/port=3000'
      - 'prometheus.io/path=/api/metrics'
    environment:
      NODE_ENV: development
      PORT: '3000'
      HOSTNAME: '0.0.0.0'
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000/graphql}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:4000/graphql}
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY:-}
      NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      INTERNAL_API_URL: http://api:4000/graphql
      # OpenTelemetry
      OTEL_SERVICE_NAME: appname-web
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_ENABLE_TRACING: ${OTEL_ENABLE_TRACING:-true}
      OTEL_ENABLE_METRICS: ${OTEL_ENABLE_METRICS:-true}
      # Browser sends to collector via HTTP (exposed port)
      NEXT_PUBLIC_OTEL_ENDPOINT: http://localhost:4318
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - appname-network
      - observability

  # ===========================================================================
  # Workers (Profile: workers)
  # ===========================================================================
  worker_reminders:
    image: appname-api:dev
    container_name: worker_reminders
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:reminders']
    labels:
      - 'com.appname.service=worker-reminders'
      - 'com.appname.env=dev'
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
      # OpenTelemetry
      OTEL_SERVICE_NAME: appname-worker-reminders
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_TRACE_SAMPLE_RATE: ${OTEL_TRACE_SAMPLE_RATE:-1.0}
      OTEL_ENABLE_TRACING: ${OTEL_ENABLE_TRACING:-true}
      OTEL_ENABLE_METRICS: ${OTEL_ENABLE_METRICS:-true}
      OTEL_ENABLE_LOGGING: ${OTEL_ENABLE_LOGGING:-true}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network
      - observability

  worker_feedback:
    image: appname-api:dev
    container_name: worker_feedback
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:feedback']
    labels:
      - 'com.appname.service=worker-feedback'
      - 'com.appname.env=dev'
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      APP_URL: http://localhost:3000
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Appname Dev <dev@localhost>}
      # OpenTelemetry
      OTEL_SERVICE_NAME: appname-worker-feedback
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_TRACE_SAMPLE_RATE: ${OTEL_TRACE_SAMPLE_RATE:-1.0}
      OTEL_ENABLE_TRACING: ${OTEL_ENABLE_TRACING:-true}
      OTEL_ENABLE_METRICS: ${OTEL_ENABLE_METRICS:-true}
      OTEL_ENABLE_LOGGING: ${OTEL_ENABLE_LOGGING:-true}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network
      - observability

  worker_audit:
    image: appname-api:dev
    container_name: worker_audit
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: development
    restart: unless-stopped
    profiles: ['workers', 'all']
    command: ['pnpm', '-C', 'apps/api', 'worker:audit-archive']
    labels:
      - 'com.appname.service=worker-audit'
      - 'com.appname.env=dev'
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/app?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-min-32-characters-long-change-me}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      # OpenTelemetry
      OTEL_SERVICE_NAME: appname-worker-audit
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_TRACE_SAMPLE_RATE: ${OTEL_TRACE_SAMPLE_RATE:-1.0}
      OTEL_ENABLE_TRACING: ${OTEL_ENABLE_TRACING:-true}
      OTEL_ENABLE_METRICS: ${OTEL_ENABLE_METRICS:-true}
      OTEL_ENABLE_LOGGING: ${OTEL_ENABLE_LOGGING:-true}
    volumes:
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network
      - observability

  # ===========================================================================
  # Adminer (Profile: tools)
  # ===========================================================================
  adminer:
    image: adminer:latest
    container_name: adminer
    restart: unless-stopped
    profiles: ['tools', 'all']
    ports:
      - '8080:8080'
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network
    labels:
      - 'com.appname.service=adminer'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Stripe CLI (Profile: stripe)
  # ===========================================================================
  stripe:
    image: stripe/stripe-cli:latest
    container_name: stripe
    restart: unless-stopped
    profiles: ['stripe', 'all']
    command:
      [
        'listen',
        '--forward-to',
        'http://api:4000/webhooks/stripe',
        '--log-level',
        'info',
      ]
    environment:
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_DEVICE_NAME: appname-docker
    depends_on:
      api:
        condition: service_healthy
    networks:
      - appname-network
    labels:
      - 'com.appname.service=stripe'
      - 'com.appname.env=dev'

# =============================================================================
# Networks
# =============================================================================
networks:
  appname-network:
    driver: bridge
  # External network for observability stack (run `pnpm obs:up` first)
  observability:
    external: true
    name: observability

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: appname-dev-postgres-data
  redis_data:
    name: appname-dev-redis-data
  api_uploads:
    name: appname-dev-api-uploads
  api_tmp:
    name: appname-dev-api-tmp
  api_audit:
    name: appname-dev-api-audit
