# =============================================================================
# Core Fragments - Base entities
# =============================================================================

fragment SessionUserCore on SessionUser {
  id
  name
  email
  role
  imageUrl
  verifiedAt
}

fragment UserCore on User {
  id
  email
  name
  role
  imageUrl
  verifiedAt
  createdAt
  updatedAt
  lastSeenAt
  locale
  tz
  acceptedTermsAt
  acceptedMarketingAt
}

fragment CategoryCore on Category {
  id
  slug
  names # JSONObject with translated labels by locale
  createdAt
  updatedAt
}

fragment TagCore on Tag {
  id
  label
  slug
  createdAt
  updatedAt
}

# =============================================================================
# Intent Member Fragments
# =============================================================================

fragment IntentMemberCore on IntentMember {
  id
  intentId
  userId
  role
  status
  joinedAt
  leftAt
  note
  user {
    ...UserCore
  }
  addedBy {
    id
    name
    imageUrl
  }
  intent {
    ...IntentLight
  }
}

# Lightweight member fragment (for lists)
fragment IntentMemberLight on IntentMember {
  id
  role
  status
  joinedAt
  user {
    id
    name
    imageUrl
  }
}

# =============================================================================
# Intent Fragments
# =============================================================================

# Lightweight intent fragment (for lists/cards)
fragment IntentLight on Intent {
  id
  title
  description

  visibility
  joinMode
  mode
  min
  max

  startAt
  endAt

  # ── Join windows / status (new)
  status
  allowJoinLate
  joinOpensMinutesBeforeStart
  joinCutoffMinutesBeforeStart
  lateJoinCutoffMinutesAfterStart
  joinManuallyClosed
  joinOpen
  lockReason

  meetingKind
  onlineUrl

  lat
  lng
  address
  placeId
  radiusKm

  levels

  addressVisibility
  membersVisibility

  # Derived / computed
  joinedCount
  commentsCount
  messagesCount
  isFull
  hasStarted
  hasEnded
  isCanceled
  isDeleted
  canJoin
  isOngoing

  ownerId

  createdAt
  updatedAt

  categories {
    ...CategoryCore
  }
  tags {
    ...TagCore
  }

  owner {
    id
    name
    imageUrl
  }
}

# Full intent fragment (for detail views)
fragment IntentCore on Intent {
  id
  title
  description
  notes

  visibility
  joinMode
  mode
  min
  max

  startAt
  endAt

  # ── Join windows / cutoffs / manual lock (new)
  allowJoinLate
  joinOpensMinutesBeforeStart
  joinCutoffMinutesBeforeStart
  lateJoinCutoffMinutesAfterStart
  joinManuallyClosed
  joinManuallyClosedAt
  joinManuallyClosedBy {
    id
    name
    imageUrl
  }
  joinManualCloseReason

  meetingKind
  onlineUrl

  lat
  lng
  address
  placeId
  radiusKm

  levels

  addressVisibility
  membersVisibility

  # Computed helpers (resolver-calculated)
  status # (new)
  joinedCount
  commentsCount
  messagesCount
  isFull
  hasStarted
  hasEnded
  canJoin
  joinOpen # (new)
  lockReason # (new)
  isOngoing
  withinLock
  isOnsite
  isOnline
  isHybrid

  # Ownership
  ownerId

  # Cancellation (read-only)
  canceledAt
  canceledBy {
    ...UserCore
  }
  cancelReason
  isCanceled

  # Soft-delete (read-only)
  deletedAt
  deletedBy {
    ...UserCore
  }
  deleteReason
  isDeleted

  createdAt
  updatedAt

  categories {
    ...CategoryCore
  }
  tags {
    ...TagCore
  }

  # Convenience relations (access-controlled)
  owner {
    ...UserCore
  }
  members {
    ...IntentMemberCore
  }
}

# Extended intent fragment for detail page (includes sponsorship, inviteLinks)
fragment IntentDetail on Intent {
  ...IntentCore
  sponsorship {
    ...EventSponsorshipCore
  }
  inviteLinks {
    ...IntentInviteLinkCore
  }
}

# =============================================================================
# Notification Fragments
# =============================================================================

fragment NotificationCore on Notification {
  id
  kind
  title
  body
  data
  dedupeKey
  entityType
  entityId
  readAt
  createdAt

  recipient {
    ...UserCore
  }
  actor {
    id
    name
    imageUrl
  }

  # Convenience relation when entityType=INTENT
  intent {
    id
    title
    startAt
    status # useful for surfacing context in toasts
  }
}

fragment NotificationBadgeChangedCore on NotificationBadgeChanged {
  recipientId
}

# =============================================================================
# Pagination Fragments
# =============================================================================

fragment PageInfoCore on PageInfo {
  total
  limit
  offset
  hasNext
  hasPrev
}

fragment CursorPageInfoCore on CursorPageInfo {
  hasNextPage
  endCursor
}

fragment UsersResultCore on UsersResult {
  items {
    ...UserCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

fragment IntentsResultCore on IntentsResult {
  items {
    ...IntentCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

fragment NotificationsResultCore on NotificationsResult {
  items {
    ...NotificationCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

# Lightweight intents result (for lists)
fragment IntentsResultLight on IntentsResult {
  items {
    ...IntentLight
  }
  pageInfo {
    ...PageInfoCore
  }
}

# =============================================================================
# Direct Messages Fragments
# =============================================================================

fragment DmMessageCore on DmMessage {
  id
  threadId
  senderId
  content
  replyToId
  createdAt
  readAt
  editedAt
  deletedAt
  sender {
    id
    name
    imageUrl
  }
  reactions {
    ...MessageReactionCore
  }
}

fragment DmMessageWithReply on DmMessage {
  ...DmMessageCore
  replyTo {
    ...DmMessageCore
  }
}

fragment MessageReactionCore on MessageReaction {
  emoji
  count
  users {
    id
    name
    imageUrl
  }
  reacted
}

fragment DmThreadCore on DmThread {
  id
  aUserId
  bUserId
  pairKey
  createdAt
  updatedAt
  lastMessageAt
  unreadCount

  aUser {
    id
    name
    imageUrl
    lastSeenAt
  }
  bUser {
    id
    name
    imageUrl
    lastSeenAt
  }

  lastMessage {
    ...DmMessageCore
  }
}

fragment DmThreadLight on DmThread {
  id
  aUserId
  bUserId
  createdAt
  updatedAt
  lastMessageAt
  unreadCount

  aUser {
    id
    name
    imageUrl
  }
  bUser {
    id
    name
    imageUrl
  }

  lastMessage {
    id
    content
    createdAt
    senderId
  }
}

fragment DmMuteCore on DmMute {
  id
  threadId
  userId
  muted
  createdAt
}

fragment DmThreadsResultCore on DmThreadsResult {
  items {
    ...DmThreadCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

# =============================================================================
# Comments Fragments
# =============================================================================

fragment CommentCore on Comment {
  id
  intentId
  authorId
  threadId
  parentId
  content
  createdAt
  updatedAt
  deletedAt
  repliesCount

  author {
    id
    name
    imageUrl
  }
}

fragment CommentWithReplies on Comment {
  ...CommentCore
  replies {
    ...CommentCore
  }
}

fragment CommentsResultCore on CommentsResult {
  items {
    ...CommentCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

# =============================================================================
# Reviews Fragments
# =============================================================================

fragment ReviewCore on Review {
  id
  intentId
  authorId
  rating
  content
  createdAt
  updatedAt
  deletedAt

  author {
    id
    name
    imageUrl
  }
}

fragment ReviewsResultCore on ReviewsResult {
  items {
    ...ReviewCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

fragment ReviewStatsCore on ReviewStats {
  totalCount
  averageRating
  ratingDistribution {
    rating
    count
  }
}

# =============================================================================
# Reports Fragments
# =============================================================================

fragment ReportCore on Report {
  id
  reporterId
  entity
  entityId
  reason
  status
  createdAt
  resolvedAt

  reporter {
    id
    name
    imageUrl
  }
}

fragment ReportsResultCore on ReportsResult {
  items {
    ...ReportCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

# =============================================================================
# Event Chat Fragments
# =============================================================================

fragment IntentChatMessageCore on IntentChatMessage {
  id
  intentId
  authorId
  content
  replyToId
  createdAt
  editedAt
  deletedAt
  isEdited
  isDeleted

  author {
    id
    name
    imageUrl
  }
  reactions {
    ...MessageReactionCore
  }
}

fragment IntentChatMessageWithReply on IntentChatMessage {
  ...IntentChatMessageCore
  replyTo {
    ...IntentChatMessageCore
  }
}

fragment IntentChatMessagesResultCore on IntentChatMessagesResult {
  items {
    ...IntentChatMessageWithReply
  }
  pageInfo {
    ...CursorPageInfoCore
  }
  hasMore
}

# =============================================================================
# User Blocks Fragments
# =============================================================================

fragment UserBlockCore on UserBlock {
  id
  blockerId
  blockedId
  createdAt

  blocker {
    id
    name
    imageUrl
  }
  blocked {
    id
    name
    imageUrl
  }
}

fragment UserBlocksResultCore on UserBlocksResult {
  items {
    ...UserBlockCore
  }
  pageInfo {
    ...PageInfoCore
  }
}

# =============================================================================
# Intent Invite Links Fragments
# =============================================================================

fragment IntentInviteLinkCore on IntentInviteLink {
  id
  intentId
  code
  maxUses
  usedCount
  expiresAt
  createdAt
  isExpired
  isMaxedOut
  isValid
}

# =============================================================================
# Notification Preferences Fragments
# =============================================================================

fragment NotificationPreferenceCore on NotificationPreference {
  id
  userId
  emailOnInvite
  emailOnJoinRequest
  emailOnMessage
  pushOnReminder
  inAppOnEverything
  createdAt
  updatedAt
}

# =============================================================================
# Mutes Fragments
# =============================================================================

fragment IntentMuteCore on IntentMute {
  id
  intentId
  userId
  muted
  createdAt
}

fragment DmMuteCore on DmMute {
  id
  threadId
  userId
  muted
  createdAt
}

# =============================================================================
# Event Sponsorship Fragments
# =============================================================================

fragment EventSponsorshipCore on EventSponsorship {
  id
  intentId
  sponsorId
  plan
  status
  highlightOn
  startedAt
  endsAt
  boostsUsed
  localPushes
  createdAt
  updatedAt

  sponsor {
    id
    name
    imageUrl
  }
}
