# =============================================================================
# Deploy to Stage
# =============================================================================
# Deploys to stage environment
# Triggered by: build-and-push workflow or manual dispatch
# =============================================================================
name: Deploy Stage

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., sha-abc1234)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  NAMESPACE: appname-stage
  CLUSTER_NAME: appname-cluster  # Update with your EKS cluster name

jobs:
  deploy:
    name: Deploy to Stage
    runs-on: ubuntu-latest
    environment: stage
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ==== Configure AWS (for EKS) ====
      # Uncomment when using EKS
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ secrets.AWS_REGION }}
      #
      # - name: Update kubeconfig
      #   run: aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      # ==== Run Database Migrations ====
      - name: Run Database Migrations
        run: |
          echo "Running migrations for image: ${{ inputs.image_tag }}"
          
          # Update migration job image
          cd infra/k8s/envs/stage
          kustomize edit set image appname-api=${{ env.REGISTRY }}/${{ github.repository }}/api:${{ inputs.image_tag }}
          
          # Apply migration job
          kubectl apply -f ../../components/api/migration-job.yaml -n ${{ env.NAMESPACE }}
          
          # Wait for migration to complete
          kubectl wait --for=condition=complete job/migrate-db -n ${{ env.NAMESPACE }} --timeout=300s
          
          # Check migration logs
          kubectl logs job/migrate-db -n ${{ env.NAMESPACE }}
          
          # Delete completed job
          kubectl delete job migrate-db -n ${{ env.NAMESPACE }} --ignore-not-found
        continue-on-error: true  # Skip if no cluster configured yet

      # ==== Deploy Application ====
      - name: Deploy to Stage
        run: |
          echo "Deploying to stage with image tag: ${{ inputs.image_tag }}"
          
          cd infra/k8s/envs/stage
          
          # Update image tags
          kustomize edit set image \
            appname-api=${{ env.REGISTRY }}/${{ github.repository }}/api:${{ inputs.image_tag }} \
            appname-web=${{ env.REGISTRY }}/${{ github.repository }}/web:${{ inputs.image_tag }}
          
          # Apply manifests
          kubectl apply -k .
          
          # Wait for rollout
          kubectl rollout status deployment/api -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/web -n ${{ env.NAMESPACE }} --timeout=300s
        continue-on-error: true  # Skip if no cluster configured yet

      # ==== Smoke Tests ====
      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests..."
          
          # Get API endpoint (update with your actual domain)
          API_URL="${{ vars.STAGE_API_URL || 'https://stage.api.example.com' }}"
          
          # Health check
          echo "Checking API health..."
          curl -sf "${API_URL}/health" || echo "Health check skipped (no endpoint configured)"
          
          # Readiness check
          echo "Checking API readiness..."
          curl -sf "${API_URL}/health/ready" || echo "Readiness check skipped (no endpoint configured)"
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | stage |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ inputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ env.NAMESPACE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

