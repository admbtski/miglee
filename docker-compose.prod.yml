# =============================================================================
# Appname Production Docker Compose
# =============================================================================
#
# Production-like stack for local testing before K8s deployment.
# Uses production targets (minimal images, non-root users, tini).
#
# Usage:
#   # 1. Build images
#   pnpm prod:build
#
#   # 2. Start infrastructure
#   pnpm prod:up:infra
#
#   # 3. Run migrations (one-off)
#   pnpm prod:migrate
#
#   # 4. Run migrations + seed (first time only)
#   pnpm prod:migrate:seed
#
#   # 5. Start services
#   pnpm prod:up
#
#   # 6. Start workers
#   pnpm prod:up:workers
#
#   # 7. Stop all
#   pnpm prod:down
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 + PostGIS 3.4
  # ===========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-app}
      TZ: Europe/Warsaw
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-app}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - appname-network

  # ===========================================================================
  # Redis 7 (with AOF persistence)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - '6379:6379'
    command:
      [
        'redis-server',
        '--appendonly',
        'yes',
        '--maxmemory',
        '512mb',
        '--maxmemory-policy',
        'allkeys-lru',
      ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - appname-network

  # ===========================================================================
  # Migrator (one-off job for DB migrations + optional seed)
  # ===========================================================================
  migrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: migrator
    profiles: ['migrator']
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-app}?schema=public
      # Set RUN_SEED=1 to seed after migration
      RUN_SEED: ${RUN_SEED:-0}
      SEED_TYPE: ${SEED_TYPE:-prod}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - appname-network

  # ===========================================================================
  # API - Fastify + GraphQL + Prisma (Production)
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: production
    restart: unless-stopped
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: production
      SERVICE_NAME: ${SERVICE_NAME:-app}
      HOST: '0.0.0.0'
      PORT: '4000'
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-app}?schema=public
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_TLS: 'false'
      # Security
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FILE_PATH: ${LOG_FILE_PATH:-}
      # URLs
      APP_URL: ${APP_URL:-http://localhost:3000}
      API_URL: ${API_URL:-http://localhost:4000}
      ASSETS_BASE_URL: ${ASSETS_BASE_URL:-http://localhost:4000}
      # Storage
      MEDIA_STORAGE_PROVIDER: ${MEDIA_STORAGE_PROVIDER:-LOCAL}
      UPLOADS_PATH: /app/uploads
      UPLOADS_TMP_PATH: /app/tmp/uploads
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      # Image processing
      IMAGE_MAX_WIDTH: ${IMAGE_MAX_WIDTH:-2560}
      IMAGE_MAX_HEIGHT: ${IMAGE_MAX_HEIGHT:-2560}
      IMAGE_FORMAT: ${IMAGE_FORMAT:-webp}
      IMAGE_QUALITY: ${IMAGE_QUALITY:-85}
      # Media cleanup
      ENABLE_MEDIA_CLEANUP: ${ENABLE_MEDIA_CLEANUP:-false}
      MEDIA_CLEANUP_INTERVAL_HOURS: ${MEDIA_CLEANUP_INTERVAL_HOURS:-24}
      MEDIA_CLEANUP_AGE_DAYS: ${MEDIA_CLEANUP_AGE_DAYS:-7}
      # S3 (if using)
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      # CDN
      CDN_ENABLED: ${CDN_ENABLED:-false}
      CDN_BASE_URL: ${CDN_BASE_URL:-}
      # Admin
      ENABLE_BULL_BOARD: ${ENABLE_BULL_BOARD:-false}
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_SUB: ${STRIPE_PRICE_USER_PLUS_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PLUS_YEARLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_SUB: ${STRIPE_PRICE_USER_PRO_MONTHLY_SUB:-}
      STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_MONTHLY_ONEOFF:-}
      STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF: ${STRIPE_PRICE_USER_PRO_YEARLY_ONEOFF:-}
      STRIPE_PRICE_ACTION_PACKAGE_SMALL: ${STRIPE_PRICE_ACTION_PACKAGE_SMALL:-}
      STRIPE_PRICE_ACTION_PACKAGE_MEDIUM: ${STRIPE_PRICE_ACTION_PACKAGE_MEDIUM:-}
      STRIPE_PRICE_ACTION_PACKAGE_LARGE: ${STRIPE_PRICE_ACTION_PACKAGE_LARGE:-}
      STRIPE_PRICE_EVENT_PLUS: ${STRIPE_PRICE_EVENT_PLUS:-}
      STRIPE_PRICE_EVENT_PRO: ${STRIPE_PRICE_EVENT_PRO:-}
      # Email
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@example.com}
    volumes:
      - api_uploads:/app/uploads
      - api_tmp:/app/tmp/uploads
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:4000/health/live', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - appname-network

  # ===========================================================================
  # Web - Next.js 15 (Production)
  # ===========================================================================
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: production
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000/graphql}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:4000/graphql}
        NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY:-}
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      PORT: '3000'
      HOSTNAME: '0.0.0.0'
      # Runtime env (server-side only)
      INTERNAL_API_URL: http://api:4000/graphql
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - appname-network

  # ===========================================================================
  # Workers (Profile: workers)
  # ===========================================================================
  worker_reminders:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: production
    restart: unless-stopped
    profiles: ['workers']
    command: ['node', 'runtime/dist/src/workers/reminders/worker.js']
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-app}?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      APP_URL: ${APP_URL:-http://localhost:3000}
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@example.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_feedback:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: production
    restart: unless-stopped
    profiles: ['workers']
    command: ['node', 'runtime/dist/src/workers/feedback/worker.js']
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-app}?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      APP_URL: ${APP_URL:-http://localhost:3000}
      API_URL: http://api:4000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@example.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

  worker_audit:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      target: production
    restart: unless-stopped
    profiles: ['workers']
    command: ['node', 'runtime/dist/src/workers/audit-archive/worker.js']
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-app}?schema=public
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      REDIS_TLS: 'false'
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      AUDIT_ARCHIVE_PATH: /app/data/audit-archives
      # S3 (if using for audit storage)
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
    volumes:
      - api_audit:/app/data/audit-archives
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - appname-network

# =============================================================================
# Networks
# =============================================================================
networks:
  appname-network:
    driver: bridge

# =============================================================================
# Volumes (persistent data)
# =============================================================================
volumes:
  postgres_data:
    name: appname-prod-postgres-data
  redis_data:
    name: appname-prod-redis-data
  api_uploads:
    name: appname-prod-api-uploads
  api_tmp:
    name: appname-prod-api-tmp
  api_audit:
    name: appname-prod-api-audit
