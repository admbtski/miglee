# =============================================================================
# Web Dockerfile (Next.js 15) â€” minimal runtime with standalone output
# pnpm + turborepo monorepo
# - turbo prune -> minimal workspace context
# - next build with standalone output -> minimal runtime
# =============================================================================

# -----------------------------------------------------------------------------
# Base (pnpm)
# -----------------------------------------------------------------------------
FROM node:22-alpine AS base

RUN apk add --no-cache libc6-compat
RUN corepack enable && corepack prepare pnpm@10.14.0 --activate

ENV PNPM_HOME="/root/.local/share/pnpm"
ENV PATH="${PNPM_HOME}:${PATH}"

WORKDIR /app

# -----------------------------------------------------------------------------
# Pruner (turbo prune for minimal workspace)
# -----------------------------------------------------------------------------
FROM base AS pruner

RUN apk add --no-cache git

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY apps ./apps
COPY packages ./packages

# Create pruned output for apps/web
RUN pnpm dlx turbo@latest prune --scope=apps/web --docker

# -----------------------------------------------------------------------------
# Dependencies (install deps for pruned workspace)
# -----------------------------------------------------------------------------
FROM base AS deps

# Build deps for native modules
RUN apk add --no-cache python3 make g++ openssl

# Copy pruned manifests only (better caching)
COPY --from=pruner /app/out/json/ ./
COPY --from=pruner /app/out/pnpm-lock.yaml ./pnpm-lock.yaml

RUN pnpm install --frozen-lockfile

# -----------------------------------------------------------------------------
# Builder (build Next.js with standalone output)
# -----------------------------------------------------------------------------
FROM base AS builder

ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_WS_URL

ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL}

RUN apk add --no-cache python3 make g++ openssl

# Bring node_modules from deps
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=deps /app/package.json ./package.json
COPY --from=deps /app/pnpm-workspace.yaml ./pnpm-workspace.yaml

# Copy pruned source
COPY --from=pruner /app/out/full/ ./

# Build Next.js (with standalone output configured in next.config.ts)
RUN pnpm -C apps/web build

# -----------------------------------------------------------------------------
# Development stage (optional)
# -----------------------------------------------------------------------------
FROM base AS development

RUN apk add --no-cache python3 make g++ openssl

COPY --from=deps /app/node_modules ./node_modules
COPY --from=pruner /app/out/full/ ./
COPY --from=deps /app/pnpm-lock.yaml ./pnpm-lock.yaml

EXPOSE 3000

ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Use webpack dev server (not Turbopack, which has issues in Docker)
CMD ["pnpm", "-C", "apps/web", "_dev"]

# -----------------------------------------------------------------------------
# Production (minimal runtime with standalone Next.js)
# -----------------------------------------------------------------------------
FROM node:22-alpine AS production

# Only runtime deps - no build tools
RUN apk add --no-cache libc6-compat

WORKDIR /app

# Non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy standalone output
# Next.js standalone creates: server.js + node_modules (minimal) + .next
COPY --from=builder /app/apps/web/.next/standalone ./

# Copy static files to correct locations for Next.js server
# server.js looks for .next/static relative to its location
COPY --from=builder /app/apps/web/.next/static ./.next/static
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder /app/apps/web/public ./public
COPY --from=builder /app/apps/web/public ./apps/web/public

# Copy full node_modules to resolve pnpm symlinks in standalone output
COPY --from=builder /app/node_modules ./node_modules

# Fix pnpm symlinks - they point to ../../../node_modules/.pnpm which goes outside /app
# We need to change ../../../node_modules/.pnpm to .pnpm
RUN cd /app/node_modules && \
    for link in next react react-dom; do \
      if [ -L "$link" ]; then \
        target=$(readlink "$link" | sed 's|^\.\./\.\./\.\./node_modules/||'); \
        rm "$link"; \
        ln -s "$target" "$link"; \
      fi; \
    done

# Set correct permissions
RUN chown -R nextjs:nodejs /app

USER nextjs

ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

EXPOSE 3000

CMD ["node", "server.js"]
