# =============================================================================
# Appname Infrastructure (Tryb Hybrydowy)
# =============================================================================
#
# Infrastruktura dla lokalnego developmentu. Aplikacje uruchamiasz przez pnpm dev.
#
# Usage:
#   pnpm infra:up           # Start postgres + redis
#   pnpm infra:up:tools     # + Adminer
#   pnpm infra:up:stripe    # + Stripe CLI
#   pnpm infra:up:all       # Wszystko (postgres, redis, adminer, stripe)
#   pnpm infra:down         # Stop
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 + PostGIS 3.4
  # ===========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
      TZ: Europe/Warsaw
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d app']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - 'com.appname.service=postgres'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Redis 7
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command:
      [
        'redis-server',
        '--appendonly',
        'yes',
        '--maxmemory',
        '256mb',
        '--maxmemory-policy',
        'noeviction',
      ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    labels:
      - 'com.appname.service=redis'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Adminer (Profile: tools)
  # ===========================================================================
  adminer:
    image: adminer:latest
    container_name: adminer
    restart: unless-stopped
    profiles: ['tools', 'all']
    ports:
      - '8080:8080'
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - 'com.appname.service=adminer'
      - 'com.appname.env=dev'

  # ===========================================================================
  # Stripe CLI (Profile: stripe)
  # ===========================================================================
  stripe:
    image: stripe/stripe-cli:latest
    container_name: stripe
    restart: unless-stopped
    profiles: ['stripe', 'all']
    command:
      [
        'listen',
        '--forward-to',
        'http://host.docker.internal:4000/webhooks/stripe',
        '--log-level',
        'info',
      ]
    environment:
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_DEVICE_NAME: appname-local
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    labels:
      - 'com.appname.service=stripe'
      - 'com.appname.env=dev'
    # Note: Sprawdź logi aby uzyskać webhook secret (whsec_...)
    # docker compose -f docker/docker-compose.dev.yml --profile stripe logs -f stripe

volumes:
  postgres_data:
    name: appname-postgres-data
  redis_data:
    name: appname-redis-data
