// =============================================================================
// Prisma Client & Datasource
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Enums
// =============================================================================

/// Visibility level for intents
enum Visibility {
  PUBLIC
  HIDDEN
}

/// Meeting capacity mode
enum Mode {
  ONE_TO_ONE
  GROUP
}

/// Type of meeting location/format
enum MeetingKind {
  ONSITE
  ONLINE
  HYBRID
}

/// Global user role (system-wide permissions)
enum Role {
  ADMIN
  MODERATOR
  USER
}

/// Skill/experience level
enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/// Role within a specific intent
enum IntentMemberRole {
  OWNER
  MODERATOR
  PARTICIPANT
}

/// Membership lifecycle status
enum IntentMemberStatus {
  JOINED
  PENDING
  INVITED
  REJECTED
  BANNED
  LEFT
  KICKED
}

/// Notification type/category
enum NotificationKind {
  INTENT_CREATED
  INTENT_UPDATED
  INTENT_CANCELED
  INTENT_DELETED
  INTENT_INVITE
  INTENT_MEMBERSHIP_APPROVED
  INTENT_MEMBERSHIP_REJECTED
  INTENT_REMINDER
  SYSTEM
}

/// Entity type for polymorphic notification targets
enum NotificationEntity {
  INTENT
  MESSAGE
  PAYMENT
  INVOICE
  USER
  SYSTEM
  OTHER
}

// =============================================================================
// Models
// =============================================================================

/// User account
model User {
  id         String    @id @default(cuid())
  email      String    @unique
  name       String    @unique
  imageUrl   String
  role       Role      @default(USER)
  verifiedAt DateTime  @default(now())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastSeenAt DateTime?

  // Relations
  notifications      Notification[]
  intentMembers      IntentMember[]
  addedMemberships   IntentMember[] @relation("IntentMemberAddedBy")
  actedNotifications Notification[] @relation("NotificationActor")
  canceledIntents    Intent[]       @relation("IntentCanceledBy")
  deletedIntents     Intent[]       @relation("IntentDeletedBy")

  @@index([email])
  @@index([name])
  @@index([role])
  @@index([lastSeenAt])
  @@map("users")
}

/// Category for intent classification (with i18n names)
model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  names     Json // JSON object with language keys: { "en": "...", "pl": "...", "de": "..." }
  icon      String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  intents Intent[]

  @@index([slug])
  @@map("categories")
}

/// Tag for intent filtering and search
model Tag {
  id        String   @id @default(cuid())
  label     String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  intents Intent[]

  @@index([label])
  @@index([slug])
  @@map("tags")
}

/// Intent (meeting/event)
model Intent {
  id          String  @id @default(cuid())
  title       String
  description String?
  notes       String?

  // Many-to-many relations
  categories Category[]
  tags       Tag[]

  // Visibility & capacity
  visibility Visibility @default(PUBLIC)
  mode       Mode       @default(GROUP)
  min        Int        @default(2)
  max        Int        @default(50)

  // Timing
  startAt       DateTime
  endAt         DateTime
  allowJoinLate Boolean  @default(true)

  // Meeting format
  meetingKind MeetingKind @default(ONSITE)
  onlineUrl   String?

  // Location (optional, for ONSITE/HYBRID)
  lat      Float?
  lng      Float?
  address  String?
  placeId  String?
  radiusKm Float?

  // Skill levels (array enum)
  levels Level[] @default([])

  // Cancellation (read-only business state)
  canceledAt   DateTime?
  canceledById String?
  canceledBy   User?     @relation("IntentCanceledBy", fields: [canceledById], references: [id], onDelete: SetNull)
  cancelReason String?

  // Soft-delete (typically set 30+ days after cancellation)
  deletedAt    DateTime?
  deletedById  String?
  deletedBy    User?     @relation("IntentDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull)
  deleteReason String?

  // Relations
  members       IntentMember[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for common queries
  @@index([startAt])
  @@index([endAt])
  @@index([visibility])
  @@index([mode])
  @@index([meetingKind])
  @@index([lat, lng])
  @@index([placeId])
  @@index([canceledAt])
  @@index([deletedAt])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([visibility, startAt])
  @@index([visibility, canceledAt, deletedAt])
  @@map("intents")
}

/// Intent membership (user participation in an intent)
model IntentMember {
  id String @id @default(cuid())

  intentId String
  userId   String

  // Relations
  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Membership details
  role   IntentMemberRole   @default(PARTICIPANT)
  status IntentMemberStatus @default(PENDING)

  // Audit: who added this member
  addedById String?
  addedBy   User?   @relation("IntentMemberAddedBy", fields: [addedById], references: [id], onDelete: SetNull)

  // Lifecycle timestamps
  joinedAt DateTime?
  leftAt   DateTime?
  note     String? // Reason for rejection/kick

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Constraints & indexes
  @@unique([intentId, userId])
  @@index([userId, status])
  @@index([intentId, status])
  @@index([intentId, role])
  @@index([intentId, status, role])
  @@index([userId, createdAt])
  @@map("intent_members")
}

/// Notification for user activity feed
model Notification {
  id String @id @default(cuid())

  kind NotificationKind

  // Recipient (required)
  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  // Actor (optional - who triggered this notification)
  actorId String?
  actor   User?   @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  // Polymorphic entity reference
  entityType NotificationEntity
  entityId   String?

  // Convenience: direct intent reference (when entityType=INTENT)
  intentId String?
  intent   Intent? @relation(fields: [intentId], references: [id], onDelete: SetNull)

  // Content
  title     String?
  body      String?
  data      Json?
  dedupeKey String? // Prevents duplicate notifications

  // Status
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Constraints & indexes
  @@unique([recipientId, dedupeKey])
  @@index([recipientId, readAt])
  @@index([recipientId, createdAt])
  @@index([recipientId, entityType, readAt])
  @@index([recipientId, kind, readAt])
  @@index([intentId])
  @@map("notifications")
}
