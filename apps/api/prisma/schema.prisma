// =============================================================================
// Prisma Client & Datasource
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
/**
 * Enums
 */
// =============================================================================

enum Visibility {
  PUBLIC
  HIDDEN
}

enum AddressVisibility {
  PUBLIC
  AFTER_JOIN
  HIDDEN
}

enum MembersVisibility {
  PUBLIC
  AFTER_JOIN
  HIDDEN
}

enum JoinMode {
  OPEN
  REQUEST
  INVITE_ONLY
}

enum Mode {
  ONE_TO_ONE
  GROUP
}

enum MeetingKind {
  ONSITE
  ONLINE
  HYBRID
}

enum Role {
  ADMIN
  MODERATOR
  USER
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum IntentMemberRole {
  OWNER
  MODERATOR
  PARTICIPANT
}

enum IntentMemberStatus {
  JOINED
  PENDING
  INVITED
  REJECTED
  BANNED
  LEFT
  KICKED
}

enum NotificationKind {
  INTENT_CREATED
  INTENT_UPDATED
  INTENT_CANCELED
  INTENT_DELETED
  INTENT_INVITE
  INTENT_MEMBERSHIP_APPROVED
  INTENT_MEMBERSHIP_REJECTED
  INTENT_REMINDER
  JOIN_REQUEST
  NEW_MESSAGE
  NEW_COMMENT
  NEW_REVIEW
  BANNED
  UNBANNED
  SYSTEM
}

enum NotificationEntity {
  INTENT
  MESSAGE
  PAYMENT
  INVOICE
  USER
  REVIEW
  SYSTEM
  OTHER
}

enum SponsorPlan {
  BASIC
  PLUS
  PRO
}

enum SponsorshipStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
}

enum SubscriptionPlan {
  BASIC
  PLUS
  PRO
}

enum SubscriptionStatus {
  INCOMPLETE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
}

enum MemberEvent {
  JOIN
  REQUEST
  APPROVE
  REJECT
  LEAVE
  KICK
  BAN
  UNBAN
  INVITE
  ACCEPT_INVITE
}

enum ReportEntity {
  INTENT
  COMMENT
  REVIEW
  USER
  MESSAGE
}

// =============================================================================
/**
 * Models
 */
// =============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String    @unique
  imageUrl         String?
  role             Role      @default(USER)
  verifiedAt       DateTime?
  suspendedAt      DateTime? // Admin suspension
  suspensionReason String? // Reason for suspension
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastSeenAt       DateTime?

  // Profile / Preferences
  locale              String? // e.g. "pl-PL", "en-US"
  tz                  String? // IANA TZ, np. "Europe/Warsaw"
  acceptedTermsAt     DateTime?
  acceptedMarketingAt DateTime?

  // Relations
  notifications         Notification[]
  actedNotifications    Notification[]      @relation("NotificationActor")
  intentMembers         IntentMember[]
  addedMemberships      IntentMember[]      @relation("IntentMemberAddedBy")
  canceledIntents       Intent[]            @relation("IntentCanceledBy")
  deletedIntents        Intent[]            @relation("IntentDeletedBy")
  ownedIntents          Intent[]            @relation("IntentOwner")
  memberEventsAsSubject IntentMemberEvent[] @relation("MemberEventUser")
  memberEventsAsActor   IntentMemberEvent[] @relation("MemberEventActor")

  // NEW: intents z rcznie zamknitymi zapisami
  joinClosedIntents Intent[] @relation("IntentJoinClosedBy")

  // Social
  commentsWritten Comment[] @relation("CommentAuthor")
  reviewsWritten  Review[]  @relation("ReviewAuthor")

  // DM
  dmThreadsA        DmThread[]          @relation("DmA")
  dmThreadsB        DmThread[]          @relation("DmB")
  dmMessages        DmMessage[]
  dmMutes           DmMute[]
  dmReads           DmRead[] // last read per thread
  dmMessageReactions DmMessageReaction[] @relation("DmMessageReactions")

  // Event Chat
  intentChatMessages         IntentChatMessage[]
  intentChatReads            IntentChatRead[]
  intentChatMessageReactions IntentChatMessageReaction[] @relation("IntentChatMessageReactions")

  // Mutes / Prefs
  notificationPreference NotificationPreference?
  intentMutes            IntentMute[]

  // Moderation
  reportsFiled    Report[]    @relation("ReportAuthor")
  blocksInitiated UserBlock[] @relation("Blocker")
  blocksReceived  UserBlock[] @relation("Blocked")

  // Ownership transfers
  ownershipTransfersFrom  IntentOwnershipTransfer[] @relation("IotFrom")
  ownershipTransfersTo    IntentOwnershipTransfer[] @relation("IotTo")
  ownershipTransfersActed IntentOwnershipTransfer[] @relation("IotActor")

  // Monetization
  subscriptions     UserSubscription[]
  eventSponsorships EventSponsorship[] @relation("SponsorUser")

  // Profile & Privacy
  profile      UserProfile?
  privacy      UserPrivacy?
  stats        UserStats?
  socialLinks  UserSocialLink[]
  disciplines  UserDiscipline[]
  availability UserAvailability[]
  badges       UserBadge[]

  @@index([email])
  @@index([name])
  @@index([role])
  @@index([lastSeenAt])
  @@map("users")
}

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  names     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  intents         Intent[]
  userDisciplines UserDiscipline[]

  @@index([slug])
  @@map("categories")
}

model Tag {
  id        String   @id @default(cuid())
  label     String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  intents Intent[]

  @@index([label])
  @@index([slug])
  @@map("tags")
}

model Intent {
  id          String  @id @default(cuid())
  title       String
  description String?
  notes       String?

  categories Category[]
  tags       Tag[]

  visibility Visibility @default(PUBLIC)
  joinMode   JoinMode   @default(OPEN)

  mode Mode @default(GROUP)
  min  Int  @default(2)
  max  Int  @default(50)

  startAt DateTime
  endAt   DateTime

  //  Zapisy / okna / cutoffy 
  /// Otwarcie zapis贸w X minut przed startem (null = bez ogranicze, od publikacji).
  joinOpensMinutesBeforeStart     Int?
  /// Zamknicie zapis贸w przed startem: now >= startAt - X minut (null = brak pre-cutoffu).
  joinCutoffMinutesBeforeStart    Int?
  /// Pozw贸l docza po starcie (late join).
  allowJoinLate                   Boolean   @default(true)
  /// Zamknicie late-join po starcie: now >= startAt + X minut (null = do endAt).
  lateJoinCutoffMinutesAfterStart Int?
  /// Rczne zamknicie zapis贸w (nadpisuje powy偶sze).
  joinManuallyClosed              Boolean   @default(false)
  joinManuallyClosedAt            DateTime?
  joinManuallyClosedById          String?
  joinManuallyClosedBy            User?     @relation("IntentJoinClosedBy", fields: [joinManuallyClosedById], references: [id], onDelete: SetNull)
  joinManualCloseReason           String?

  meetingKind MeetingKind @default(ONSITE)
  onlineUrl   String?

  lat      Float?
  lng      Float?
  address  String?
  placeId  String?
  radiusKm Float?

  // Note: PostGIS 'geom' column (geography(Point, 4326)) is managed via SQL migration
  // and not directly in this schema. See migration: 20251104220540_add_postgis_geom
  // The 'geom' column is automatically populated from lat/lng and has a GIST index.

  levels Level[] @default([])

  addressVisibility AddressVisibility @default(PUBLIC)
  membersVisibility MembersVisibility @default(PUBLIC)

  // Derived counters
  joinedCount   Int @default(0)
  commentsCount Int @default(0)
  messagesCount Int @default(0)

  // Ownership
  ownerId            String?
  owner              User?                     @relation("IntentOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  ownershipTransfers IntentOwnershipTransfer[]

  // Cancellation / deletion
  canceledAt   DateTime?
  canceledById String?
  canceledBy   User?     @relation("IntentCanceledBy", fields: [canceledById], references: [id], onDelete: SetNull)
  cancelReason String?

  deletedAt    DateTime?
  deletedById  String?
  deletedBy    User?     @relation("IntentDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull)
  deleteReason String?

  // Relations
  members       IntentMember[]
  memberEvents  IntentMemberEvent[]
  notifications Notification[]
  comments      Comment[]
  reviews       Review[]
  sponsorship   EventSponsorship?
  inviteLinks   IntentInviteLink[]
  mutes         IntentMute[]

  // Event Chat relations
  chatMessages IntentChatMessage[]
  chatReads    IntentChatRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([startAt])
  @@index([endAt])
  @@index([visibility])
  @@index([joinMode])
  @@index([mode])
  @@index([meetingKind])
  @@index([lat, lng])
  @@index([placeId])
  @@index([canceledAt])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([visibility, meetingKind, startAt])
  @@index([visibility, startAt, joinedCount])
  @@index([joinManuallyClosed, startAt])
  @@index([joinOpensMinutesBeforeStart])
  @@index([joinCutoffMinutesBeforeStart])
  @@index([lateJoinCutoffMinutesAfterStart])
  @@map("intents")
}

model IntentMember {
  id       String @id @default(cuid())
  intentId String
  userId   String

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role   IntentMemberRole   @default(PARTICIPANT)
  status IntentMemberStatus @default(PENDING)

  addedById String?
  addedBy   User?   @relation("IntentMemberAddedBy", fields: [addedById], references: [id], onDelete: SetNull)

  joinedAt DateTime?
  leftAt   DateTime?
  note     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([intentId, userId])
  @@index([userId, status])
  @@index([intentId, status])
  @@index([intentId, role])
  @@index([intentId, status, role])
  @@index([userId, createdAt])
  @@map("intent_members")
}

model IntentMemberEvent {
  id        String      @id @default(cuid())
  intentId  String
  userId    String
  actorId   String?
  kind      MemberEvent
  note      String?
  createdAt DateTime    @default(now())

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)

  user  User  @relation("MemberEventUser", fields: [userId], references: [id], onDelete: Cascade)
  actor User? @relation("MemberEventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([intentId, createdAt])
  @@index([userId, createdAt])
  @@map("intent_member_events")
}

model Comment {
  id        String    @id @default(cuid())
  intentId  String
  authorId  String
  threadId  String // root comment id; dla root贸w = id (ustaw w app)
  parentId  String?
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  intent  Intent    @relation(fields: [intentId], references: [id], onDelete: Cascade)
  author  User      @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentParent", fields: [parentId], references: [id], onDelete: SetNull)
  replies Comment[] @relation("CommentParent")

  @@index([intentId, createdAt])
  @@index([authorId, createdAt])
  @@index([intentId, threadId, createdAt])
  @@index([parentId, createdAt])
  @@map("comments")
}

model Review {
  id        String    @id @default(cuid())
  intentId  String
  authorId  String
  rating    Int // enforce 1..5 in SQL CHECK (migration)
  content   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  author User   @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@unique([intentId, authorId])
  @@index([intentId, createdAt])
  @@index([authorId, createdAt])
  @@index([intentId, rating, createdAt])
  @@map("reviews")
}

model DmThread {
  id            String    @id @default(cuid())
  aUserId       String
  bUserId       String
  pairKey       String    @unique // `${min(aUserId,bUserId)}|${max(aUserId,bUserId)}`
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?

  aUser    User        @relation("DmA", fields: [aUserId], references: [id], onDelete: Cascade)
  bUser    User        @relation("DmB", fields: [bUserId], references: [id], onDelete: Cascade)
  messages DmMessage[]
  mutes    DmMute[]
  reads    DmRead[] // last read markers per user

  @@index([aUserId, bUserId])
  @@index([lastMessageAt])
  @@map("dm_threads")
}

model DmMessage {
  id        String    @id @default(cuid())
  threadId  String
  senderId  String
  content   String
  replyToId String?
  createdAt DateTime  @default(now())
  readAt    DateTime?
  editedAt  DateTime? // added for parity with event chat
  deletedAt DateTime?

  thread    DmThread            @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender    User                @relation(fields: [senderId], references: [id], onDelete: Cascade)
  reactions DmMessageReaction[]

  replyTo DmMessage?  @relation("DmMessageReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies DmMessage[] @relation("DmMessageReply")

  @@index([threadId, createdAt])
  @@index([senderId, createdAt])
  @@map("dm_messages")
}

model DmMessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String // , わ, , , , 
  createdAt DateTime @default(now())

  message DmMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User      @relation("DmMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("dm_message_reactions")
}

model Notification {
  id String @id @default(cuid())

  kind NotificationKind

  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  actorId String?
  actor   User?   @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  entityType NotificationEntity
  entityId   String?

  intentId String?
  intent   Intent? @relation(fields: [intentId], references: [id], onDelete: SetNull)

  title     String?
  body      String?
  data      Json?
  dedupeKey String?

  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([recipientId, dedupeKey])
  @@index([recipientId, readAt])
  @@index([recipientId, createdAt])
  @@index([recipientId, entityType, readAt])
  @@index([recipientId, kind, readAt])
  @@index([intentId])
  @@map("notifications")
}

// ========================== Event Chat ==========================

model IntentChatMessage {
  id        String    @id @default(cuid())
  intentId  String
  authorId  String
  content   String
  replyToId String?
  createdAt DateTime  @default(now())
  editedAt  DateTime?
  deletedAt DateTime?

  intent    Intent                     @relation(fields: [intentId], references: [id], onDelete: Cascade)
  author    User                       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactions IntentChatMessageReaction[]

  replyTo IntentChatMessage?  @relation("IntentChatReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies IntentChatMessage[] @relation("IntentChatReply")

  @@index([intentId, createdAt])
  @@index([authorId, createdAt])
  @@map("intent_chat_messages")
}

model IntentChatMessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String // , わ, , , , 
  createdAt DateTime @default(now())

  message IntentChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User               @relation("IntentChatMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("intent_chat_message_reactions")
}

model IntentChatRead {
  id         String   @id @default(cuid())
  intentId   String
  userId     String
  lastReadAt DateTime @default(now())

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([intentId, userId])
  @@index([userId, lastReadAt])
  @@map("intent_chat_reads")
}

// ========================== DM Reads ==========================

model DmRead {
  id         String   @id @default(cuid())
  threadId   String
  userId     String
  lastReadAt DateTime @default(now())

  thread DmThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([userId, lastReadAt])
  @@map("dm_reads")
}

// ========================== Moderation ==========================

model UserBlock {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
  @@map("user_blocks")
}

model Report {
  id         String       @id @default(cuid())
  reporterId String
  entity     ReportEntity
  entityId   String
  reason     String
  status     String       @default("OPEN")
  createdAt  DateTime     @default(now())
  resolvedAt DateTime?

  reporter User @relation("ReportAuthor", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([entity, entityId])
  @@index([status, createdAt])
  @@map("reports")
}

// ========================== Monetization ==========================

model UserSubscription {
  id                   String             @id @default(cuid())
  userId               String
  plan                 SubscriptionPlan   @default(BASIC)
  status               SubscriptionStatus @default(INCOMPLETE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([stripeSubscriptionId])
  @@index([currentPeriodEnd])
  @@map("user_subscriptions")
}

model EventSponsorship {
  id          String            @id @default(cuid())
  intentId    String            @unique
  sponsorId   String
  plan        SponsorPlan       @default(BASIC)
  status      SponsorshipStatus @default(PENDING)
  highlightOn Boolean           @default(false)
  startedAt   DateTime?
  endsAt      DateTime?
  boostsUsed  Int               @default(0)
  localPushes Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  intent  Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  sponsor User   @relation("SponsorUser", fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([plan, status])
  @@index([endsAt])
  @@map("event_sponsorships")
}

model PaymentEvent {
  id          String    @id @default(cuid())
  provider    String    @default("stripe")
  eventId     String    @unique
  type        String
  payload     Json
  receivedAt  DateTime  @default(now())
  processedAt DateTime?
  success     Boolean   @default(false)
  attempt     Int       @default(1)
  lastError   String?

  @@index([type, receivedAt])
  @@map("payment_events")
}

// ========================== Invites ==========================

model IntentInviteLink {
  id        String    @id @default(cuid())
  intentId  String
  code      String    @unique
  maxUses   Int?
  usedCount Int       @default(0)
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)

  @@index([intentId, expiresAt])
  @@map("intent_invite_links")
}

// ========================== Preferences & Mutes ==========================

model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  emailOnInvite      Boolean  @default(true)
  emailOnJoinRequest Boolean  @default(true)
  emailOnMessage     Boolean  @default(false)
  pushOnReminder     Boolean  @default(true)
  inAppOnEverything  Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model IntentMute {
  id        String   @id @default(cuid())
  intentId  String
  userId    String
  muted     Boolean  @default(true)
  createdAt DateTime @default(now())

  intent Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([intentId, userId])
  @@map("intent_mutes")
}

model DmMute {
  id        String   @id @default(cuid())
  threadId  String
  userId    String
  muted     Boolean  @default(true)
  createdAt DateTime @default(now())

  thread DmThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@map("dm_mutes")
}

// ========================== Ownership transfers ==========================

model IntentOwnershipTransfer {
  id         String   @id @default(cuid())
  intentId   String
  fromUserId String
  toUserId   String
  actorId    String?
  reason     String?
  createdAt  DateTime @default(now())

  intent   Intent @relation(fields: [intentId], references: [id], onDelete: Cascade)
  fromUser User   @relation("IotFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User   @relation("IotTo", fields: [toUserId], references: [id], onDelete: Cascade)
  actor    User?  @relation("IotActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([intentId, createdAt])
  @@map("intent_ownership_transfers")
}

// =============================================================================
/**
 * User Profile & Privacy Models
 */
// =============================================================================

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Public display
  displayName String?
  bioShort    String? // max 200 chars
  bioLong     String? // max 1000 chars

  // Location
  city    String?
  country String?
  homeLat Float?
  homeLng Float?

  // Media
  coverUrl String?

  // Preferences
  speaks                  String[] // ["pl", "en"]
  interests               String[] // tags
  preferredMode           Mode? // ONE_TO_ONE / GROUP
  preferredMaxDistanceKm  Float?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserPrivacy {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // DM policy
  dmPolicy String @default("ALL") // ALL / MEMBERS / INVITE_ONLY / NONE

  // Visibility settings
  showLastSeen   String @default("ALL") // ALL / MEMBERS / HIDDEN
  showLocation   String @default("CITY") // CITY / APPROX / HIDDEN
  showEvents     String @default("ALL") // ALL / MEMBERS / SELF
  showReviews    String @default("ALL") // ALL / MEMBERS / SELF
  showStats      String @default("ALL") // ALL / MEMBERS / SELF

  // Default visibility for new intents
  defaultAddressVisibility AddressVisibility @default(PUBLIC)
  defaultMembersVisibility MembersVisibility @default(PUBLIC)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_privacy")
}

model UserStats {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Denormalized counters
  eventsCreated Int @default(0)
  eventsJoined  Int @default(0)
  reviewsCount  Int @default(0)

  // Ratings
  hostRatingAvg     Float?
  attendeeRatingAvg Float?

  // Activity
  lastActiveAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

model UserSocialLink {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider String // instagram / facebook / strava / x / discord / website
  url      String
  verified Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@map("user_social_links")
}

model UserDiscipline {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryId String
  level      Level
  notes      String?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
  @@map("user_disciplines")
}

model UserAvailability {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  weekday  Int // 0 = Monday, 6 = Sunday
  startMin Int // 0-1440 (minutes from midnight)
  endMin   Int // 0-1440
  tzSnap   String? // Timezone snapshot

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, weekday])
  @@map("user_availability")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())

  slug     String // e.g. "first_event", "10_events", "verified"
  data     Json? // Additional metadata
  earnedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@map("user_badges")
}
