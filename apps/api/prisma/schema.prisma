generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ---------- Enums ----------
 */

enum Visibility {
  PUBLIC
  HIDDEN
}

enum Mode {
  ONE_TO_ONE
  GROUP
}

enum MeetingKind {
  ONSITE
  ONLINE
  HYBRID
}

enum NotificationKind {
  INTENT_CREATED
  // future: INTENT_UPDATED, INTENT_CANCELED, USER_MENTIONED, SYSTEM, ...
}

enum Role {
  ADMIN
  MODERATOR
  USER
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/**
 * ---------- Models ----------
 */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  imageUrl  String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // authored intents
  intents       Intent[]
  // received notifications
  notifications Notification[]

  @@map("users")
}

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  /// Localized names in JSON, e.g. { "pl": "Bieganie", "de": "Laufen", "en": "Running" }
  names     Json
  icon      String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // M:N with intents
  intents Intent[]

  @@map("categories")
}

model Tag {
  id        String   @id @default(cuid())
  label     String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // M:N with intents
  intents Intent[]

  @@index([label], map: "idx_tags_label")
  @@map("tags")
}

model Intent {
  id          String  @id @default(cuid())
  title       String
  description String?
  notes       String?

  // Categories (M:N)
  categories Category[]

  // Tags (M:N) for search/filtering
  tags Tag[]

  // Visibility
  visibility Visibility @default(PUBLIC)

  // Mode & capacity
  mode Mode @default(GROUP)
  min  Int  @default(2)
  max  Int  @default(50)

  // Time window
  startAt       DateTime
  endAt         DateTime
  allowJoinLate Boolean  @default(true)

  // Meeting type
  meetingKind MeetingKind @default(ONSITE)

  // ONLINE
  onlineUrl String?

  // ONSITE/HYBRID â€“ geo + address + radius (km)
  lat      Float?
  lng      Float?
  address  String?
  radiusKm Float? // 0 = precise pin; >0 = privacy radius

  // Difficulty levels for search (PostgreSQL enum array)
  levels Level[] @default([])

  // Author (nullable; keep SetNull to avoid the SetNull-on-required-field issue)
  authorId String?
  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  // Back-relation to notifications
  notifications Notification[] @relation("IntentNotifications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt], map: "idx_intents_start_at")
  @@index([visibility], map: "idx_intents_visibility")
  @@index([authorId], map: "idx_intents_author")
  @@index([lat, lng], map: "idx_intents_lat_lng")
  @@map("intents")
}

model Notification {
  id      String           @id @default(cuid())
  kind    NotificationKind
  message String?
  payload Json?
  readAt  DateTime?

  // Recipient
  recipientId String
  recipient   User   @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  // Related intent (optional)
  intentId String?
  intent   Intent? @relation("IntentNotifications", fields: [intentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([recipientId, createdAt], map: "idx_notifications_recipient_created")
  @@index([recipientId, readAt], map: "idx_notifications_unread")
  @@index([intentId], map: "idx_notifications_intent")
  @@map("notifications")
}

model Event {
  id        String   @id @default(cuid())
  title     String
  createdAt DateTime @default(now())

  @@map("events")
}
