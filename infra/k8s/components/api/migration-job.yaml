# =============================================================================
# Database Migration Job
# =============================================================================
# This job runs Prisma migrations before deploying new API version.
# It should be applied separately and completed before rolling out the API.
#
# Usage:
#   kubectl apply -f migration-job.yaml
#   kubectl wait --for=condition=complete job/migrate-db --timeout=300s
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: migrate-db
  labels:
    app.kubernetes.io/name: appname
    app.kubernetes.io/component: migration
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  template:
    metadata:
      labels:
        app.kubernetes.io/name: appname
        app.kubernetes.io/component: migration
    spec:
      serviceAccountName: api
      restartPolicy: Never
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      
      containers:
        - name: migrate
          image: appname-api:latest
          imagePullPolicy: IfNotPresent
          
          # Run Prisma migrations
          command: ["npx"]
          args: ["prisma", "migrate", "deploy", "--schema=./apps/api/prisma/schema.prisma"]
          
          # Environment variables
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets
          
          env:
            - name: NODE_ENV
              value: "production"
          
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

