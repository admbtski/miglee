# Grafana Alert Rules for Core Web Vitals
# These alerts notify when Web Vitals metrics exceed Google's recommended thresholds

apiVersion: 1

groups:
  - orgId: 1
    name: web-vitals-production
    folder: Web Vitals
    interval: 5m
    rules:
      # =========================================
      # LCP (Largest Contentful Paint) Alerts
      # =========================================
      
      - uid: web-vitals-lcp-poor
        title: üî¥ LCP Poor - Above 4s (Critical)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_lcp_milliseconds_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 4000
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 4000
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'LCP p75 is {{$values.A.Value}}ms (threshold: 4000ms). This indicates poor user experience. Immediate action required.'
          summary: 'Core Web Vitals: LCP is in POOR range (>4s)'
          runbook_url: 'https://web.dev/lcp/'
        labels:
          severity: critical
          team: frontend
          metric: lcp

      - uid: web-vitals-lcp-needs-improvement
        title: üü° LCP Needs Improvement - 2.5s to 4s (Warning)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_lcp_milliseconds_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2500
                      - 4000
                    type: within_range
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          description: 'LCP p75 is {{$values.A.Value}}ms (threshold: 2500ms). Performance needs improvement.'
          summary: 'Core Web Vitals: LCP needs improvement (2.5-4s)'
          runbook_url: 'https://web.dev/lcp/'
        labels:
          severity: warning
          team: frontend
          metric: lcp

      # =========================================
      # INP (Interaction to Next Paint) Alerts
      # =========================================

      - uid: web-vitals-inp-poor
        title: üî¥ INP Poor - Above 500ms (Critical)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_inp_milliseconds_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 500
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'INP p75 is {{$values.A.Value}}ms (threshold: 500ms). Users experiencing significant interaction delays.'
          summary: 'Core Web Vitals: INP is in POOR range (>500ms)'
          runbook_url: 'https://web.dev/inp/'
        labels:
          severity: critical
          team: frontend
          metric: inp

      - uid: web-vitals-inp-needs-improvement
        title: üü° INP Needs Improvement - 200ms to 500ms (Warning)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_inp_milliseconds_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 200
                      - 500
                    type: within_range
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          description: 'INP p75 is {{$values.A.Value}}ms (threshold: 200ms). Interaction responsiveness needs improvement.'
          summary: 'Core Web Vitals: INP needs improvement (200-500ms)'
          runbook_url: 'https://web.dev/inp/'
        labels:
          severity: warning
          team: frontend
          metric: inp

      # =========================================
      # CLS (Cumulative Layout Shift) Alerts
      # =========================================

      - uid: web-vitals-cls-poor
        title: üî¥ CLS Poor - Above 0.25 (Critical)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_cls_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.25
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'CLS p75 is {{$values.A.Value}} (threshold: 0.25). Significant visual instability detected.'
          summary: 'Core Web Vitals: CLS is in POOR range (>0.25)'
          runbook_url: 'https://web.dev/cls/'
        labels:
          severity: critical
          team: frontend
          metric: cls

      - uid: web-vitals-cls-needs-improvement
        title: üü° CLS Needs Improvement - 0.1 to 0.25 (Warning)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.75, sum(rate(app_web_vitals_cls_bucket[5m])) by (le))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                      - 0.25
                    type: within_range
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          description: 'CLS p75 is {{$values.A.Value}} (threshold: 0.1). Visual stability needs improvement.'
          summary: 'Core Web Vitals: CLS needs improvement (0.1-0.25)'
          runbook_url: 'https://web.dev/cls/'
        labels:
          severity: warning
          team: frontend
          metric: cls

      # =========================================
      # Percentage of Good Experiences
      # =========================================

      - uid: web-vitals-good-percentage-low
        title: ‚ö†Ô∏è Good Experience Rate Below 75% (Warning)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '100 * sum(rate(app_web_vitals_lcp_milliseconds_count{web_vital_rating="good"}[5m])) / sum(rate(app_web_vitals_lcp_milliseconds_count[5m]))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 75
                      - 0
                    type: lt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 15m
        annotations:
          description: 'Only {{$values.A.Value}}% of users are having a "Good" LCP experience (target: ‚â•75%). This affects SEO ranking.'
          summary: 'Core Web Vitals: Good experience rate below target'
          runbook_url: 'https://web.dev/vitals/'
        labels:
          severity: warning
          team: frontend
          metric: good-rate

      # =========================================
      # Data Volume Monitoring
      # =========================================

      - uid: web-vitals-low-sample-count
        title: ‚ö†Ô∏è Low Web Vitals Sample Count
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'sum(rate(app_web_vitals_lcp_milliseconds_count[5m]))'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.01
                      - 0
                    type: lt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: Alerting
        execErrState: Error
        for: 10m
        annotations:
          description: 'Web Vitals sample rate is {{$values.A.Value}} samples/s. This is too low for statistical significance.'
          summary: 'Web Vitals: Insufficient data volume'
        labels:
          severity: warning
          team: observability
          metric: sample-count

# Contact points and notification policies should be configured separately in Grafana UI
# or via contact_points.yaml and notification_policies.yaml

